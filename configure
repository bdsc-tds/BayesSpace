: ${R_HOME=`R RHOME`}
if test -z "${R_HOME}"; then
  echo "could not determine R_HOME"
  exit 1
fi

# Check meson
if test -z "$MESON"; then MESON="`which meson`"; fi
if test ! -f "$MESON"; then echo "no 'meson' command found"; exit 1; fi

# Check ninja
if test -z "$NINJA"; then NINJA="`which ninja`"; fi
if test ! -f "$NINJA"; then echo "no 'ninja' command found"; exit 1; fi

CC=`"${R_HOME}/bin/R" CMD config CC`
CFLAGS=`"${R_HOME}/bin/R" CMD config CFLAGS`
CXX=`"${R_HOME}/bin/R" CMD config CXX17`
CXXFLAGS=`"${R_HOME}/bin/R" CMD config CXX17FLAGS`
CPPFLAGS=`"${R_HOME}/bin/R" CMD config CPPFLAGS`
LDFLAGS=`"${R_HOME}/bin/R" CMD config LDFLAGS`

cd src

# Install libvips
if test ! -r "libvips"; then
  rm -rf "libvips"
  git clone https://github.com/libvips/libvips.git
fi

# if test ! -r "libvips/build"; then
  cd libvips
  rm -rf "build"
  meson setup build --prefix "$PWD/build/lib" -Dtiff=enabled -Djpeg=enabled
  cd build
  meson compile
  meson test
  meson install
  cd ../..
# fi
